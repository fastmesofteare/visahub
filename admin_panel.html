<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel – Visa Approval</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { background-color: #f0f2f5; font-family: 'Montserrat', Arial, sans-serif; }
    .navbar { background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .dashboard-main-content { margin-top: 90px; padding: 20px; max-width: 1400px; margin: auto; }
    .dashboard-card { border-radius:15px; padding:20px; color:#fff; display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; min-height:120px; }
    .card-approved { background: linear-gradient(to right,#4CAF50,#8bc34a); }
    .card-pending { background: linear-gradient(to right,#ff9800,#ffc107); }
    .card-rejected { background: linear-gradient(to right,#f44336,#e57373); }
    .card-title { font-size:1.2rem; font-weight:600; }
    .card-value { font-size:2.5rem; font-weight:800; }
    .loan-request-section { background:#fff; border-radius:15px; padding:30px; margin-top:20px; }
    .loan-request-title { font-size:1.8rem; font-weight:700; color:#333; margin-bottom:20px; display:flex; align-items:center; gap:10px; }
    .btn-approve { background:#28a745; color:#fff; font-weight:600; padding:8px 15px; border-radius:8px; border:none; }
    .btn-reject { background:#dc3545; color:#fff; font-weight:600; padding:8px 15px; border-radius:8px; border:none; }
    .status-badge { padding:5px 10px; border-radius:5px; font-weight:bold; font-size:0.85em; }
    .status-pending { background:#fff3cd; color:#856404; }
    .status-approved { background:#d4edda; color:#155724; }
    .status-rejected { background:#f8d7da; color:#721c24; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img src="/1000205315-removebg-preview.png" alt="logo" style="width:40px;height:40px;">
        <span class="fw-bold">Visa|Lord Admin</span>
      </a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav gap-3">
          <li class="nav-item"><a class="nav-link" id="adminProfileLink"><i class="bi bi-person-circle"></i> Admin</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="dashboard-main-content">
    <div id="notLoggedIn" class="alert alert-warning text-center" style="display: none;">
      You must <a href="admin_login.html">login as admin</a> to access this panel.
    </div>
    <div id="adminContent" style="display: none;">
      <div class="row mb-4">
        <div class="col-md-4"><div class="dashboard-card card-approved"><div><div class="card-title">Approved</div><div class="card-value" id="approvedCount">0</div></div></div></div>
        <div class="col-md-4"><div class="dashboard-card card-pending"><div><div class="card-title">Pending</div><div class="card-value" id="pendingCount">0</div></div></div></div>
        <div class="col-md-4"><div class="dashboard-card card-rejected"><div><div class="card-title">Rejected</div><div class="card-value" id="rejectedCount">0</div></div></div></div>
      </div>

      <div class="loan-request-section">
        <div class="loan-request-title"><i class="bi bi-person-lines-fill"></i> Visa Applications</div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead><tr><th>Name</th><th>Email</th><th>Visa Type</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="applicationsTableBody"></tbody>
          </table>
        </div>
        <div id="noApplications" class="text-center text-muted mt-4" style="display:none;">No applications found.</div>
      </div>
    </div>
  </div>
<hr class="my-5">

<div class="loan-request-title"><i class="bi bi-folder-check"></i> Uploaded Applications (Ready for Payment)</div>
<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Visa Type</th>
        <th>Payment Amount</th>
        <th>Set Amount</th>
      </tr>
    </thead>
    <tbody id="uploadedApplicationsTableBody"></tbody>
  </table>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDO5Bpeg0Ewg6lUzbIaI-Kp4wC9ET6OQfE",
      authDomain: "visasponsor-e62c2.firebaseapp.com",
      projectId: "visasponsor-e62c2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
async function fetchApplications() {
  const body = document.getElementById("applicationsTableBody");
  const uploadedBody = document.getElementById("uploadedApplicationsTableBody");

  body.innerHTML = '<tr><td colspan="5" class="text-center">Loading…</td></tr>';
  uploadedBody.innerHTML = '';

  let approved = 0, pending = 0, rejected = 0;

  const snap = await db.collection("visaApplications").get();
  body.innerHTML = "";

  if (snap.empty) {
    document.getElementById("noApplications").style.display = "block";
    return;
  }

  snap.forEach(doc => {
    const d = doc.data();
    const status = d.status || "pending";

    // Count status
    if (status === "approved") approved++;
    else if (status === "rejected") rejected++;
    else pending++;

    // Show in first table (all applications)
    body.innerHTML += `
      <tr>
        <td>${d.fullName || "–"}</td>
        <td>${d.email || "–"}</td>
        <td>${d.visaType || "–"}</td>
        <td><span class="status-badge status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
        <td>
          <button class="btn btn-sm btn-approve" data-id="${doc.id}" ${status === "approved" ? "disabled" : ""}>Approve</button>
          <button class="btn btn-sm btn-reject" data-id="${doc.id}" ${status === "rejected" ? "disabled" : ""}>Reject</button>
        </td>
      </tr>
    `;

    // If user has uploaded both photo and passport
    if (d.photoUrl && d.passportUrl) {
      uploadedBody.innerHTML += `
        <tr>
          <td>${d.fullName || "–"}</td>
          <td>${d.email || "–"}</td>
          <td>${d.visaType || "–"}</td>
          <td>
            <input type="number" class="form-control" id="amount-${doc.id}" value="${d.paymentAmount || ''}" placeholder="Enter amount">
          </td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="setPaymentAmount('${doc.id}')">Save</button>
          </td>
        </tr>
      `;
    }
  });

  document.getElementById("approvedCount").innerText = approved;
  document.getElementById("pendingCount").innerText = pending;
  document.getElementById("rejectedCount").innerText = rejected;

  document.querySelectorAll(".btn-approve").forEach(btn => btn.onclick = () => updateStatus(btn.dataset.id, "approved"));
  document.querySelectorAll(".btn-reject").forEach(btn => btn.onclick = () => updateStatus(btn.dataset.id, "rejected"));
}
async function setPaymentAmount(docId) {
  const amount = document.getElementById(`amount-${docId}`).value;
  if (!amount || isNaN(amount) || Number(amount) <= 0) {
    alert("Please enter a valid amount.");
    return;
  }

  try {
    await db.collection("visaApplications").doc(docId).update({
      paymentAmount: Number(amount),
      paymentStatus: "pending"
    });
    alert("Amount updated successfully.");
  } catch (err) {
    console.error(err);
    alert("Failed to update amount.");
  }
}


    async function updateStatus(id,status) {
      await db.collection("visaApplications").doc(id).update({status});
      fetchApplications();
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        document.getElementById("notLoggedIn").style.display = "block";
        return;
      }
      try {
        const doc = await db.collection("userRoles").doc(user.uid).get();
        if (doc.exists && doc.data().role === "admin") {
          document.getElementById("notLoggedIn").style.display = "none";
          document.getElementById("adminContent").style.display = "block";
          document.getElementById("adminProfileLink").innerHTML = `<i class="bi bi-person-circle"></i> ${user.email}`;
          fetchApplications();
        } else {
          await auth.signOut();
          window.location.href = "admin_login.html";
        }
      } catch(err) {
        console.error(err);
        await auth.signOut();
        window.location.href = "admin_login.html";
      }
    });

    document.getElementById("logoutBtn").onclick = async () => {
      await auth.signOut();
      window.location.href = "admin_login.html";
    };
  </script>
</body>
</html>
