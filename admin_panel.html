<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panel - Visa Approval</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Montserrat', Arial, sans-serif; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .navbar-brand { color: #333 !important; font-weight: 700; }
        .navbar-brand small { font-size: 0.7em; display: block; line-height: 1; }
        .navbar-nav .nav-link { color: #555 !important; font-weight: 500; }
        .navbar-nav .nav-link.active, .navbar-nav .nav-link:hover { color: #1766d9 !important; }
        .dashboard-main-content { margin-top: 90px; padding: 20px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .dashboard-card { border-radius: 15px; padding: 20px; color: white; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; min-height: 120px; }
        .card-approved { background: linear-gradient(to right, #4CAF50, #8bc34a); }
        .card-pending { background: linear-gradient(to right, #ff9800, #ffc107); }
        .card-rejected { background: linear-gradient(to right, #f44336, #e57373); }
        .card-revenue { background: #ffffff; color: #333; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .card-title { font-size: 1.2rem; font-weight: 600; }
        .card-value { font-size: 2.5rem; font-weight: 800; }
        .chart-placeholder { width: 80px; height: 80px; border-radius: 50%; border: 8px solid #ddd; border-top-color: #1766d9; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: #1766d9; }
        .loan-request-section { background-color: #fff; border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-top: 20px; }
        .loan-request-title { font-size: 1.8rem; font-weight: 700; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .loan-request-title i { font-size: 2rem; color: #1766d9; }
        .table-responsive { overflow-x: auto; }
        .table { min-width: 1800px; border-collapse: separate; border-spacing: 0 10px; }
        .table thead th { border-bottom: 2px solid #dee2e6; padding: 15px 10px; font-weight: 700; color: #555; text-transform: uppercase; font-size: 0.9em; background-color: #f8f9fa; }
        .table tbody tr { background-color: #ffffff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; transition: transform 0.2s; }
        .table tbody tr:hover { transform: translateY(-3px); }
        .table tbody td { padding: 15px 10px; vertical-align: middle; border-top: none; border-bottom: none; white-space: nowrap; }
        .table tbody tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .table tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .btn-approve { background-color: #28a745; border: none; font-weight: 600; padding: 8px 15px; border-radius: 8px; }
        .btn-approve:hover { background-color: #218838; }
        .btn-reject { background-color: #dc3545; border: none; font-weight: 600; padding: 8px 15px; border-radius: 8px; }
        .btn-reject:hover { background-color: #c82333; }
        .status-badge { padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 0.85em; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-rejected { background-color: #f8d7da; color: #721c24; }
        .status-progress-1, .status-progress-2, .status-progress-3 { background-color: #cfe2ff; color: #084298; font-weight: bold; padding: 5px 10px; border-radius: 5px; font-size: 0.85em; }
        .footer-nav { margin-top: 50px; padding: 20px 0; background: #ffffff; text-align: center; border-top: 1px solid #eee; font-size: 0.85rem; color: #555; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05); }
        .footer-nav a { color: #1766d9; text-decoration: none; margin: 0 5px; }
        .footer-nav a:hover { text-decoration: underline; }
        .footer-bottom { background-color: #343a40; color: #fff; padding: 30px 0; text-align: center; font-size: 0.85rem; }
        .footer-bottom .col-md-4 { margin-bottom: 20px; }
        .footer-bottom h5 { color: #fff; margin-bottom: 15px; font-weight: 600; }
        .footer-bottom p, .footer-bottom a { color: #bbb; text-decoration: none; }
        .footer-bottom a:hover { color: #fff; }
        .footer-bottom ul { list-style: none; padding: 0; }
        .footer-bottom ul li { margin-bottom: 8px; }
        .footer-bottom .contact-info i { margin-right: 10px; color: #1766d9; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid px-4">
             <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
          <img src="1000205315-removebg-preview.png" alt="visahub" style="width: 40px; height: 40px;">
          <span class="fw-bold">Visa|Hub</small></span>
        </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="mainNav">
                <ul class="navbar-nav gap-3">
                    <li class="nav-item"><a class="nav-link" href="admin_panel.html"> <i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="adminProfileLink"><i class="bi bi-person-circle"></i> Admin</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard-main-content">
        <div id="notLoggedIn" class="alert alert-warning text-center" style="display: none;">
            You must <a href="admin_login.html">login as admin</a> to access this panel.
        </div>
        <div id="adminContent" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="dashboard-card card-approved">
                        <div>
                            <div class="card-title">Approved Applications</div>
                            <div class="card-value" id="approvedCount">0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card card-pending">
                        <div>
                            <div class="card-title">Pending Applications</div>
                            <div class="card-value" id="pendingCount">0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card card-rejected">
                        <div>
                            <div class="card-title">Rejected Applications</div>
                            <div class="card-value" id="rejectedCount">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loan-request-section">
                <h2 class="loan-request-title"><i class="bi bi-person-lines-fill"></i> Visa Applications</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Date of Birth</th>
                                <th>Marital Status</th>
                                <th>Nationality</th>
                                <th>Visa Type</th>
                                <th>Country</th>
                                <th>Passport Number</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                            </tbody>
                    </table>
                </div>
                <div id="noApplications" class="text-center text-muted mt-4" style="display: none;">
                    No new applications found.
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-nav">
        Need help? <a href="contact.html">Contact Support</a> | <a href="index.html">Back to Home</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDO5Bpeg0Ewg6lUzbIaI-Kp4wC9ET6OQfE",
            authDomain: "visasponsor-e62c2.firebaseapp.com",
            projectId: "visasponsor-e62c2",
            storageBucket: "visasponsor-e62c2.firebasestorage.app",
            messagingSenderId: "179101134570",
            appId: "1:179101134570:web:bea801f12c1a620717b193",
            measurementId: "G-NE7T0PPG6K"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const adminEmail = "admin@visahub.com"; // Set your admin's email here

        const fetchApplications = async () => {
            const applicationsTableBody = document.getElementById('applicationsTableBody');
            applicationsTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Loading applications...</td></tr>';
            
            let approvedCount = 0;
            let pendingCount = 0;
            let rejectedCount = 0;

            try {
                const querySnapshot = await db.collection('visaApplications').get();
                applicationsTableBody.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    document.getElementById('noApplications').style.display = 'block';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const status = data.status || 'pending';
                    const progress = data.progress;

                    if (status === 'approved') approvedCount++;
                    else if (status === 'rejected') rejectedCount++;
                    else pendingCount++;

                    let statusBadgeClass = '';
                    let statusText = '';
                    if (status === 'approved') {
                        statusBadgeClass = 'status-approved';
                        statusText = 'Approved';
                    } else if (status === 'rejected') {
                        statusBadgeClass = 'status-rejected';
                        statusText = 'Rejected';
                    } else if (progress < 4) {
                        statusBadgeClass = `status-progress-${progress}`;
                        statusText = `In Progress (Step ${progress} of 4)`;
                    } else {
                        statusBadgeClass = 'status-pending';
                        statusText = 'Pending Approval';
                    }

                    const row = `
                        <tr>
                            <td>${data.fullName || 'N/A'}</td>
                            <td>${data.email || 'N/A'}</td>
                            <td>${data.dob || 'N/A'}</td>
                            <td>${data.maritalStatus || 'N/A'}</td>
                            <td>${data.nationality || 'N/A'}</td>
                            <td>${data.visaType || 'N/A'}</td>
                            <td>${data.countryToVisa || 'N/A'}</td>
                            <td>${data.passportNumber || 'N/A'}</td>
                            <td><span class="status-badge ${statusBadgeClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-sm btn-approve" data-id="${doc.id}" ${status === 'approved' ? 'disabled' : ''}>Approve</button>
                                <button class="btn btn-sm btn-reject" data-id="${doc.id}" ${status === 'rejected' ? 'disabled' : ''}>Reject</button>
                            </td>
                        </tr>
                    `;
                    applicationsTableBody.innerHTML += row;
                });
                
                document.getElementById('approvedCount').innerText = approvedCount;
                document.getElementById('pendingCount').innerText = pendingCount;
                document.getElementById('rejectedCount').innerText = rejectedCount;

                document.querySelectorAll('.btn-approve').forEach(btn => {
                    btn.addEventListener('click', () => updateApplicationStatus(btn.dataset.id, 'approved'));
                });
                document.querySelectorAll('.btn-reject').forEach(btn => {
                    btn.addEventListener('click', () => updateApplicationStatus(btn.dataset.id, 'rejected'));
                });

            } catch (error) {
                console.error("Error fetching applications:", error);
                applicationsTableBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error fetching data. Please try again.</td></tr>';
            }
        };

        const updateApplicationStatus = async (docId, newStatus) => {
            const confirmation = confirm(`Are you sure you want to ${newStatus} this application?`);
            if (!confirmation) return;

            try {
                await db.collection("visaApplications").doc(docId).update({ status: newStatus });
                console.log(`Application ${docId} has been ${newStatus}.`);
                fetchApplications(); // Reload data to update the UI
            } catch (error) {
                console.error("Error updating application status:", error);
                alert(`Failed to update status: ${error.message}`);
            }
        };

        auth.onAuthStateChanged(user => {
            if (user && user.email === adminEmail) {
                document.getElementById('notLoggedIn').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                document.getElementById('adminProfileLink').innerHTML = `<i class="bi bi-person-circle"></i> ${user.email}`;
                fetchApplications();
            } else {
                document.getElementById('notLoggedIn').style.display = 'block';
                document.getElementById('adminContent').style.display = 'none';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = "admin_login.html";
            } catch (error) {
                console.error("Error logging out:", error);
            }
        });
        auth.onAuthStateChanged(async (user) => {
  if (user) {
    const userRoleDoc = await db.collection("userRoles").doc(user.uid).get();
    const role = userRoleDoc.data().role;

    if (role !== "admin") {
      alert("Access denied: You are not an admin.");
      await auth.signOut();
      window.location.href = "admin_panel.html";
    } else {
      // Load admin dashboard
      console.log("Welcome Admin!");
    }
  } else {
    window.location.href = "admin_panel.html";
  }
});

    </script>
</body>
</html>