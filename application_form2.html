<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visa Application - Step 2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f2f2f2; padding-top: 20px; }
    .container { max-width: 800px; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    .form-label { font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">Visa Application - Step 2</h2>
    <form id="visaStep2Form">
      
      <h4 class="text-primary fw-bold mt-5">Other Personal Information</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="occupation" class="form-label">Occupation</label>
          <input type="text" class="form-control" id="occupation" required>
        </div>

        <div class="col-md-6">
          <label for="nationality" class="form-label">Nationality</label>
          <input type="text" class="form-control" id="nationality" required>
        </div>

        <div class="col-md-6">
          <label for="currentResidenceCountry" class="form-label">Current Residence Country</label>
          <input type="text" class="form-control" id="currentResidenceCountry" required>
        </div>

        <div class="col-md-6">
          <label for="provinceState" class="form-label">Province/State</label>
          <input type="text" class="form-control" id="provinceState" required>
        </div>

        <div class="col-md-6">
          <label for="idType" class="form-label">ID Type</label>
          <select class="form-select" id="idType" required>
            <option value="" selected disabled>Select ID Type</option>
            <option value="National ID">National ID</option>
            <option value="Driver's License">Driver's License</option>
            <option value="International Passport">International Passport</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="idNumber" class="form-label">ID Number</label>
          <input type="text" class="form-control" id="idNumber" required>
        </div>

        <div class="col-md-6">
          <label for="staffId" class="form-label">Staff ID (Optional)</label>
          <input type="text" class="form-control" id="staffId">
        </div>
      </div>

      <h4 class="text-primary fw-bold mt-5">Travel Information</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="purposes" class="form-label">Purpose of Traveling</label>
          <input type="text" class="form-control" id="purposes" required>
        </div>

        <div class="col-md-6">
          <label for="countryToVisa" class="form-label">Country to Apply Visa For</label>
          <input type="text" class="form-control" id="countryToVisa" required>
        </div>

        <div class="col-md-6">
          <label for="provinceToVisa" class="form-label">Province to Apply Visa For</label>
          <input type="text" class="form-control" id="provinceToVisa" required>
        </div>

        <div class="col-md-6">
          <label for="visaType" class="form-label">Visa Type</label>
          <select class="form-select" id="visaType" required>
            <option value="" selected disabled>Select Visa Type</option>
            <option value="Tourist Visa">Tourist Visa</option>
            <option value="Student Visa">Student Visa</option>
            <option value="Work Visa">Work Visa</option>
            <option value="Business Visa">Business Visa</option>
            <option value="Transit Visa">Transit Visa</option>
            <option value="Permanent Residence">Permanent Residence</option>
            <option value="Family/Spouse Visa">Family/Spouse Visa</option>
            <option value="Diplomatic/Official Visa">Diplomatic/Official Visa</option>
            <option value="Refugee/Humanitarian Visa">Refugee/Humanitarian Visa</option>
          </select>
        </div>
      </div>
      <div class="form-group">
    <label for="travelingDate">Traveling Date <span class="required-indicator">*</span></label>
    <input type="date"
           id="travelingDate"
           name="travelingDate"
           required
           min="YYYY-MM-DD" aria-describedby="travelingDateHelp"
           class="form-control">
    <small id="travelingDateHelp" class="form-text text-muted">Please select your intended date of departure.</small>
</div>

<div class="form-group">
    <label for="returningDate">Returning Date <span class="required-indicator">*</span></label>
    <input type="date"
           id="returningDate"
           name="returningDate"
           required
           min="YYYY-MM-DD" aria-describedby="returningDateHelp"
           class="form-control">
    <small id="returningDateHelp" class="form-text text-muted">Please select your intended date of return. Must be on or after your traveling date.</small>
</div>
      <h4 class="text-primary fw-bold mt-5">Passport Information</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="passportNumber" class="form-label">Passport Number</label>
          <input type="text" class="form-control" id="passportNumber" required>
        </div>

        <div class="col-md-6">
          <label for="passportCountry" class="form-label">Passport Issuing Country</label>
          <input type="text" class="form-control" id="passportCountry" required>
        </div>

        <div class="col-md-6">
          <label for="passportExpiry" class="form-label">Passport Expiry Date</label>
          <input type="date" class="form-control" id="passportExpiry" required>
        </div>
      </div>

      <div class="d-grid mt-4">
        <button type="button" id="nextBtn" class="btn btn-primary">Next</button>
      </div>

      <div id="formMsg" class="mt-3"></div>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDO5Bpeg0Ewg6lUzbIaI-Kp4wC9ET6OQfE",
      authDomain: "visasponsor-e62c2.firebaseapp.com",
      projectId: "visasponsor-e62c2",
      storageBucket: "visasponsor-e62c2.appspot.com",
      messagingSenderId: "179101134570",
      appId: "1:179101134570:web:bea801f12c1a620717b193"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "index.html";

      const docRef = db.collection("visaApplications").doc(user.uid);
      const doc = await docRef.get();

      if (!doc.exists || doc.data().progress < 2) {
        return window.location.href = "application_form1.html";
      }

      const data = doc.data();
      document.getElementById("travelingDate").value = data.travelingDate || "";
      document.getElementById("returningDate").value = data.returningDate || "";
      document.getElementById("occupation").value = data.occupation || "";
      document.getElementById("nationality").value = data.nationality || "";
      document.getElementById("currentResidenceCountry").value = data.currentResidenceCountry || "";
      document.getElementById("provinceState").value = data.provinceState || "";
      document.getElementById("idType").value = data.idType || "";
      document.getElementById("idNumber").value = data.idNumber || "";
      document.getElementById("staffId").value = data.staffId || "";
      document.getElementById("purposes").value = data.purposes || "";
      document.getElementById("countryToVisa").value = data.countryToVisa || "";
      document.getElementById("provinceToVisa").value = data.provinceToVisa || "";
      document.getElementById("visaType").value = data.visaType || "";
      document.getElementById("passportNumber").value = data.passportNumber || "";
      document.getElementById("passportCountry").value = data.passportCountry || "";
      document.getElementById("passportExpiry").value = data.passportExpiry || "";
    });

    document.getElementById("nextBtn").addEventListener("click", async () => {
      const form = document.getElementById("visaStep2Form");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      const formData = {
  occupation: document.getElementById("occupation").value.trim(),
  nationality: document.getElementById("nationality").value.trim(),
  currentResidenceCountry: document.getElementById("currentResidenceCountry").value.trim(),
  provinceState: document.getElementById("provinceState").value.trim(),
  idType: document.getElementById("idType").value.trim(),
  idNumber: document.getElementById("idNumber").value.trim(),
  staffId: document.getElementById("staffId").value.trim(),
  purposes: document.getElementById("purposes").value.trim(),
  countryToVisa: document.getElementById("countryToVisa").value.trim(),
  provinceToVisa: document.getElementById("provinceToVisa").value.trim(),
  visaType: document.getElementById("visaType").value.trim(),
  travelingDate: document.getElementById("travelingDate").value,    // <-- add this
  returningDate: document.getElementById("returningDate").value,    // <-- and this
  passportNumber: document.getElementById("passportNumber").value.trim(),
  passportCountry: document.getElementById("passportCountry").value.trim(),
  passportExpiry: document.getElementById("passportExpiry").value,
  progress: 3,
  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
};


      try {
        await db.collection("visaApplications").doc(user.uid).set(formData, { merge: true });
        window.location.href = "eligibility.html";
      } catch (err) {
        document.getElementById("formMsg").innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
      }
    });
  </script>
</body>
</html>
