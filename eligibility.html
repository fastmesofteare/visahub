<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Application Priview | Visa Lord</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        body { background: #eef2f7; padding: 20px; }
        .dashboard-container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; font-weight: bold; margin-bottom: 20px; }
        .info-block { margin-bottom: 20px; }
        .info-block h5 { margin-bottom: 10px; font-weight: 600; }
        .info-block p { margin-bottom: 0; }
        .btn-logout { float: right; }
        #submitApplicationWrapper { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <button class="btn btn-danger btn-sm btn-logout" id="logoutBtn">Logout</button>
    <h2>Welcome to Your Visa Application Dashboard</h2>
    <div id="userEmail" class="text-center text-muted mb-4"></div>

    <div class="info-block">
        <h5>Personal Information</h5>
        <p><strong>Full Name:</strong> <span id="fullName"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Phone:</strong> <span id="phone"></span></p>
        <p><strong>Address:</strong> <span id="address"></span></p>
        <p><strong>Date of Birth:</strong> <span id="dob"></span></p>
        <p><strong>Marital Status:</strong> <span id="maritalStatus"></span></p>
    </div>

    <div class="info-block">
        <h5>Application Information</h5>
        <p><strong>Occupation:</strong> <span id="occupation"></span></p>
        <p><strong>Nationality:</strong> <span id="nationality"></span></p>
        <p><strong>Current Residence Country:</strong> <span id="currentResidenceCountry"></span></p>
        <p><strong>Province / State:</strong> <span id="provinceState"></span></p>
        <p><strong>Country Applying For:</strong> <span id="countryToVisa"></span></p>
        <p><strong>Visa Type:</strong> <span id="visaType"></span></p>
        <p><strong>ID Type:</strong> <span id="idType"></span></p>
        <p><strong>ID Number:</strong> <span id="idNumber"></span></p>
        <p><strong>Staff ID:</strong> <span id="staffId"></span></p>
        <p><strong>Application Submitted:</strong> <span id="submittedAt"></span></p>
    </div>
</div>

<div id="submitApplicationWrapper">
    <button class="btn btn-success" id="submitApplication">Submit Application</button>
    <div id="loadingSpinner" class="spinner-border text-success mt-2" style="display: none;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDO5Bpeg0Ewg6lUzbIaI-Kp4wC9ET6OQfE",
        authDomain: "visasponsor-e62c2.firebaseapp.com",
        projectId: "visasponsor-e62c2",
        storageBucket: "visasponsor-e62c2.appspot.com",
        messagingSenderId: "179101134570",
        appId: "1:179101134570:web:bea801f12c1a620717b193"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;

    auth.onAuthStateChanged(async user => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }

        currentUser = user;
        document.getElementById("userEmail").innerText = `Logged in as: ${user.email}`;

        try {
            const doc = await db.collection("visaApplications").doc(user.uid).get();
            const data = doc.data();
            if (!data) throw new Error("No application data found.");

            const fields = [
                "fullName", "email", "phone", "address", "dob", "maritalStatus",
                "occupation", "nationality", "currentResidenceCountry", "provinceState",
                "countryToVisa", "visaType", "idType", "idNumber", "staffId"
            ];

            for (const field of fields) {
                document.getElementById(field).innerText = data[field] || "-";
            }

            document.getElementById("submittedAt").innerText = data.submittedAt?.toDate().toLocaleString() || "-";
        } catch (error) {
            alert("Failed to load data: " + error.message);
        }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await auth.signOut();
        window.location.href = "index.html";
    });

    document.getElementById("submitApplication").addEventListener("click", async () => {
        const button = document.getElementById("submitApplication");
        const spinner = document.getElementById("loadingSpinner");

        button.disabled = true;
        spinner.style.display = "inline-block";

        try {
            const docRef = db.collection("visaApplications").doc(currentUser.uid);
            await docRef.update({
                submittedAt: new Date(),
                progress: 4, // Add this line to update the progress
                status: 'pending' // Set initial status as 'pending'
            });

            alert("Application submitted successfully. You will now be redirected to your dashboard.");
            window.location.href = "dashboard.html"; // This is the updated line
        } catch (error) {
            alert("Submission failed: " + error.message);
        } finally {
            button.disabled = false;
            spinner.style.display = "none";
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>